# kzl-v3独立总结

## 开发说明

1. 现在v3整合的v2文件在v2_files的文件加里面，不建议在现有v3的基础上去使用v2_files的代码了，方便后续优化、迁移、删除废弃的代码、删除插件等。

1. v2全局组件名称统一加上了`V2`，避免与v3组件重名（本是同源，分离之后各有造诣）。

1. v2的vuex部分名称有更改，引入store，详见`@/store/index.js`, 不建议在现有v3的基础上去实用v2的module，方便后续优化删除对应module。

1. v2的router没有更改，引入store，详见`@/router/index.js`，因为登陆、路由在v2，所以现在路由的拦截、权限、守卫都在v2，引入到了v3。

1. 登陆之后的v2数据转v3数据的方法封装，详见`import {initV3GlobalData} from '@/v2_files/utils/v2_add_v3_info.js'`。

1. 样式这一块，屏蔽了element的主题设置（项目构建warning的警告（6个）是由于element-ui过低，目前是2.4.1，需要升级到2.15.7（参考），跨度太大目前暂不升级。），v2的全局样式全局引入在了v3，解决类名与v3重复的问题。后续v3写样式的时候也需要稍微注意一下，避免v2全局样式的影响，方便后续优化。

1. iframe的交互方式修改成发布订阅的模式。存在4种交互：v2的发布/订阅；v3的发布/订阅。

## 优化点

1. 梳理全局数据有两套，两者处于脱节的状态，可能会出现数据不同步的情况，后续开发造成困扰，如何维护。![vuex全局状态](../../../draw/v3_vuex.drawio.svg)

   1. 用户/连锁/品牌/门店数据定义。
   2. 封装获取的数据model.js逻辑。
   3. vuex调用model.js生成数据，以及维护全局数据（并在后续维护起来，确保数据的准确性）。
   4. 用现在有的vuex数据基础上去兼容之前的v3以及v2的全局数据，确保更新后v3与v2的数据也能更新。

2. package.json里面去除v2不需要的依赖或者替换掉，具体增加了有哪些可以参考[这次的提交](http://git.int.kzl.com.cn/k/wzl-cater-h5/commit/232cbdf9f08f40a44667cef3a0e7e9d7c3b08fec)。

3. 关于iframe的v2与v3的交互全局去除。消除不必要的性能影响，合并后的项目已经没有再用了。

4. 关于v2_files里面main.js里面的优化，比如：删除未使用的全局定义、一两个页面使用的就不使用全局定义了改为局部引用等等。

5. 关于v2_files里面一些没有用的文件。比如`_copy`命名的文件、无用图片、静态的文件、未使用的页面文件、遗弃的方法/样式 等等。

6. 关于v2新增的static看一下是否可以干掉，可以参考[这次的提交](http://git.int.kzl.com.cn/k/wzl-cater-h5/commit/99602ff13484d5a865c5dce0accf6c5cff9753bd)。
。

## 开发的注意事项

### 关于代码同步

v2后台后面有修改需要两个分支都改一下。

### 安装依赖失败

v3的webpack版本升级后安装依赖报错，需要python环境，可以到[python官网下载](https://www.python.org/downloads/release/python-2716/)对应的版本安装。

如果python默认不是需要的版本需要手动配置一下。

```bash
# 查看系统环境变量定义目录中的可执行文件路径
which python2
# 配置当前node版本npm的配置项
npm config set python /usr/local/bin/python2
```

### ci构建ETIMEDOUT

跨年后，在ci构建过程中出现出现了`ETIMEDOUT`的情况。

本地通过删除node_modules以及npm cache clean --force，复现。

解决方法：

- 删除package-lock.json
- npm install // 拉取依赖成功
- 保存package-lock.json // ci构建成功

## 测试重点

### 页面数据/交互

1. 在v2操作改变数据，查看v3页面是否保持一致，反之亦然。

    场景：用户登陆/退出、门店/品牌/连锁的切换、门店营业状态、配置项修改（新旧打印版本切换等）。

    范围：针对v2与v3页面的对比，重点关注gid、bid、sid、uid、token，多寻找不同场景不同页面对比。

2. 当前操作页面新窗口打开查看数据是否显示正常，比如用户管理里面的用户详情。

    场景：新窗口页。

    范围：针对新窗口打开的页面。

1. 页面刷新/跳转是否存在数据丢失、页面403、页面白屏、控制台报错的情况。

    场景：页面刷新/切换。

    数据范围：比如说用户登陆信息，门店连锁选择状态，刷新前后页面的显示数据情况等。

    范围：局部页面测试。

2. 菜单跳转是否正常。

    场景：主要是v2跳转v3页面，或者v3跳v2。

    数据范围：比如说用户登陆信息，门店连锁选择状态，刷新前后页面的显示数据情况等。

    范围：局部页面测试。

1. 菜单栏上方的功能测试。

    场景：全局搜索、连锁门店切换、口令、营业状态。

1. 后台长时间未操作的页面白屏问题。

2. 菜单的完整性验证，需要验证是否有丢失菜单的情况。

3. 报表中心-订单管理-订单记录 里面的订单详情弹窗交互验证。

4. 运营中心-财务管理-电子发票管理 左侧菜单待办数字显示验证。

5. 弹窗遮罩。（之前是v3、v2两层来着，现在屏蔽了v2一层）

    范围：局部页面测试。

1. 侧边“回到旧版”方法交互调整。

### 样式

1. 页面样式对比。

   范围：所有页面。
