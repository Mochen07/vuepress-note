# kzl-后台合并v5（任务拆分）

分支：`fea/merge_opt`（**不涉及功能改动的分支，只封装实现。后续根据修改的功能点拉取对应分支，并记录修改的点，形成测试用例，方便测试**。）比如：

**例1**：迁移【营销中心-精准营销】页面，基于`fea/merge_opt`拉取新分支，这时候就可以在【营销中心-精准营销】页面用整理好的封装。例如用全局数据壳子暴露出来的方法、品牌组件的实现等等。修改过程中并记录这些需要测试人员测试的功能点，形成测试用例，完成之后该分支就是一个完成的块。到时候上线可以一块一块的提测或者把几个块合在一起提测。

**例2**：封装了【商品管理的左侧分类组件】，部分页面可以用上了该组件，基于`fea/merge_opt`拉取新分支，相关页面替换，记录修改的页面，形成测试用例，完成之后该分支就是一个完成的块。

## 全局数据

壳子提供的方法（入参、返回值），以及文档完善。

### 用户信息

1. 更新用户信息
2. 获取用户信息
3. 删除用户信息
4. 从localStorage恢复store用户信息(页面登陆持久化使用)
5. 是否登陆

### 机构信息

1. 删除机构信息
2. 从localStorage恢复store机构信息
3. 是否是连锁
4. 是否是门店

#### 连锁信息

1. 更新连锁信息
2. 获取连锁信息
3. 从接口更新连锁配置信息
4. 获取连锁配置信息

#### 品牌信息

1. 获取品牌信息
2. 从接口更新品牌列表信息
3. 获取品牌列表信息

#### 门店信息

1. 更新门店信息
2. 获取门店信息
3. 从接口更新门店配置信息
4. 获取门店配置信息

### 路由信息

1. 更新路由信息
2. 获取路由信息
3. 路由拦截方法

## 组件

**问题收集，组件完善归拢，形成文档。**

### 常用组件

1. 选品牌。（龙辉已经处理了）。
2. 选门店。
3. 选商品。
4. 弹窗组件。（BaseDialog）有多种实现。
5. 页面容器组件。 （Container 或 baseLayout）有多种实现。
6. 第三方表格组件。 umy-ui和vxe-table表格组件。
7. 连锁下选门店树形组件。 新开发的时候不知道用哪个。
8. 分类组件。重复实现(比如商品管理的左侧分类组件), 有多种实现, 可以提供基础分类组件。
9. 表单组件。重复实现(开发时可以检查是否有form_x组件满足需求, 没有就补充form_y组件, 同一主题组件规范命名, 方便检索)。
10. 活动组件。重复实现(筛选, 列表卡片, 活动数据, 活动规则, 操作记录), 各种活动大体样式相同, 但新增活动时不太好复用已有组件。
11. 富文本编辑器组件。(quill, wangeditor, ueditor)。
12. 各种连锁活动基本都有下发和下发记录，之前封装了常用情况界面和业务流程，可以参考。
    1. src\components\Plan\publish
    2. src\components\Plan\publish_list
13. v2拷贝到v3的组件相似组件速查方案。去掉v2的实现,统一使用v3组件。（如何能快速找到，v3里面哪里有用到）
14. （低优先级）可以提供一份推荐使用组件指南(有多个实现时, 优先使用哪个, 不满足需求时再看其他的实现), 方便新开发时快速查找该功能的组件。

### 功能性重叠

> 单独拉分支

1. 图库组件重复实现,去掉v2的实现,统一使用v3组件。
2. 优惠券逻辑以及弹窗,去掉v2的实现,统一使用v3组件。

## 方法

1. utils文件过大，功能未拆分，需要制定`方法的收纳方案`。如：通用场景（时间、校验、图片、浏览器、框架等）。
2. 现有工具函数，还是js，新增功能还需要维护类型申明文件。（方案整理，如何解决这个问题，以下是合单迭代的处理方案）。
   1. 新增对应xx_v2.ts文件，新增功能放到新版文件中
   2. 遇到旧版功能，同步一份到xx_v2.ts中，并替换对应调用（目前是逐步替换，考虑是否全局搜索替换）。
   3. 按照现有功能，对util.js进行文件进行功能拆分。后续往拆分文件迁移和新增。
3. 时间函数存在多份，大量重复而且未明确定义不同文件的侧重点。

## 依赖

1. moment和dayjs（重复）。
2. 在项目里未找到明确使用的npm包，需要删除后是否有影响。
   1. screenfull
   2. vcolorpicker
   3. vee-validate
   4. vue-multiselect
   5. xe-utils
   6. emoji-vue
   7. swiper
   8. el-form-renderer
   9. china-area-data（有个组件使用，但该组件未被使用）
   10. vue-cropper(有个组件使用，但使用该组件的组件未被使用)
3. package.json里面去除v2不需要的依赖或者替换掉，具体增加了有哪些可以参考[这次的提交](http://git.int.kzl.com.cn/k/wzl-cater-h5/commit/232cbdf9f08f40a44667cef3a0e7e9d7c3b08fec)。

## 性能

1. 关于v2_files里面main.js里面的优化，比如：删除未使用的全局定义、一两个页面使用的就不使用全局定义了改为局部引用等等。
2. 全局数据的基础上，解决`location.reload()`全局数据更新目前是页面刷新重载的问题。
3. 关于v2新增的static看一下是否可以干掉，可以参考[这次的提交](http://git.int.kzl.com.cn/k/wzl-cater-h5/commit/99602ff13484d5a865c5dce0accf6c5cff9753bd)。
4. 清除代码中无用的console.log。
5. v3的ci构建打包优化。这里可能会对后续的优化给出一些建议。
6. 解决控制台waning。
7. 项目依赖问题。node升级之后，很多依赖并不支持当前的版本的node，在npm install的时候warning。

## 页面迁移

[excel整理](https://w4ib2x4t86.feishu.cn/sheets/L4pEssEBkhvZN1tHDk4cVhXon4d)后台所有的路由，包括有**v2后台以及v3后台的页面主路由**。

**优先处理**router、vuex，**开发前**，在`开发人员`写上自己的名（避免出现多人迁移一个页面的情况）。

### 迁移页面时候考虑

1. 清理旧版本iframe交互（v2与v3的交互全局去除）。消除不必要的性能/内存泄漏影响，合并后的项目已经没有再用了。
2. 关于iframe交互兼容的改写（$emit、$on）优化。目前项目合并在一起一些通讯是没有必要的。比如：直接引用组件、操作方法就好。
